<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>vott</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"
    crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <script>
    $(function () {
      $.post("/v1/graphql/project", { query: "query { getProjects{ projectId name } }" })
        .done(function (result) {
          const projects = result.data.getProjects;
          const $dropdown = $("#projectId");
          $.each(projects, function () {
            $dropdown.append($("<option />").val(this.projectId).text(this.name + " (" + this.projectId + ")"));
          });
        })
        .fail(function (error) {
          console.log("Unable to load projects.");
          console.log(error);
        });

      $("#projectForm").submit(function (event) {
        event.preventDefault();
        const imageFile = $("#imageFile");
        if (!imageFile.val()) {
          $("#errorModalBody").text("Please select an image to upload.");
          $("#errorModal").modal("show");
          return;
        }

        const files = imageFile[0].files;
        const projectId = $("#projectId");
        $.post("/v1/graphql/project", { query: `mutation { createImages(projectId: "${projectId.val()}", imageCount: ${files.length}) { imageId imageURL } }` })
          .done(function (result) {
            const images = result.data.createImages;
            $.each(images, function (index, currentImage) {
              const currentFile = files[index];
              const reader = new FileReader();
              reader.onload = function (event) {
                if (event.target.readyState == FileReader.DONE) {
                  const data = new Uint8Array(event.target.result);
                  $.ajax({
                    url: currentImage.imageURL,
                    type: "PUT",
                    data: data,
                    processData: false,
                    beforeSend: function (xhr) {
                      xhr.setRequestHeader('x-ms-blob-type', 'BlockBlob');
                      xhr.setRequestHeader('x-ms-blob-content-type', currentFile.type);
                    },
                    success: function (result, status) {
                      $.post("/v1/graphql/project", { query: `mutation { commitImages(images: [ { projectId: "${projectId.val()}", imageId: "${currentImage.imageId}" } ]) }` })
                        .done(function (result) {
                          if (result.errors) {
                            $("#errorModalBody").text(JSON.stringify(result.errors[0]));
                            $("#errorModal").modal("show");
                            // return;
                          }
                          console.log("Committed image successfully:");
                          console.log(currentImage);
                          console.log(result);
                        })
                        .fail(function (error) {
                          console.log("Got an error!");
                          console.log(error);
                        });
                    },
                    error: function (xhr, desc, error) {
                      $("#errorModalBody").text("Unable to upload file.  " + error);
                      $("#errorModal").modal("show");
                    }
                  })
                }
              };
              reader.readAsArrayBuffer(currentFile);
            });

          })
          .fail(function (error) {
            $("#errorModalBody").text(error);
            $("#errorModal").modal("show");
          });
      });
    });
  </script>
</head>

<body>

  <div class="container">
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="/">VoTT</a>
        </div>
        <ul class="nav navbar-nav">
          <li class="active">
            <a href="/project/">Projects</a>
          </li>
          <li>
            <a href="/logout">Log Out</a>
          </li>
        </ul>
      </div>
    </nav>
    <h2>Projects</h2>
    <form id="projectForm">
      <div class="form-group">
        <label for="projectId">Project</label>
        <select name="project" id="projectId" class="form-control"></select>
      </div>
      <div>
        <label for="imageFile">Image</label>
        <input type="file" id="imageFile" style="width: 50%;" />
        <p class="help-block">Image to add to the project.</p>
      </div>
      <button type="submit" class="btn btn-default">Upload</button>
    </form>
  </div>

  <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel">

    <div class="modal-dialog" role="document">

      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="errorModalLabel">Error</h4>
        </div>
        <div class="modal-body">
          <p id="errorModalBody">An error has occurred.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
      <!-- /.modal-content -->

    </div>
    <!-- /.modal-dialog -->

  </div>
  <!-- /.modal -->

</body>

</html>